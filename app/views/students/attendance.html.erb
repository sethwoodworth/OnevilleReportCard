<h2 class="shallow-bottom span-14 heading">Attendance</h2>
<div id="absence-summary" class="span-3 last">
  <div class="span-3">
    Total absences: <%= Attendance.all.map{|a| a.absences}.flatten.count %>
  </div>
  <div class="span-3">
    Total days late: <%= Attendance.all.map{|a| a.lates}.flatten.count %>
  </div>
</div>


<hr />
<% @attendances.each do |attendance| %>
  <% month = attendance.month %>
  <div class="column span-3 clear">
  </div>
  <div class="calendar <%= month %> span-9">
    <script type="text/javascript">
      $(document).ready(function() {

          var m = <%= month %>;

          <% if attendance.anomalies.present? %>
            var anomalyString = '<%= attendance.anomalies.to_json.html_safe %>';
            var anomalies = eval(anomalyString);

            var theEvents = [];
            for (var i = 0; i < anomalies.length; i++) {
            anomalyDescription = anomalies[i]['anomaly']['kind'];
            anomalyDay = anomalies[i]['anomaly']['school_date'].split('-')[2];
            anomalyMonth = parseInt(anomalies[i]['anomaly']['school_date'].split('-')[1]) - 1;
            anomalyYear = anomalies[i]['anomaly']['school_date'].split('-')[0];

            var theEvent = {
              title: anomalyDescription,
              start: new Date(anomalyYear, anomalyMonth, anomalyDay),
              allDay: true
              };
              theEvents.push(theEvent);
                    };

          <% else %>
            theEvents = [{}];
          <% end %>

          $('.<%= month %>').fullCalendar({
            year: 2011,
            month: m,
            date: 1,
            weekends: false,
            weekMode: 'liquid',
            editable: false,
            eventColor: '#FEFA95',
            eventTextColor: 'black',
            header : {
            center:   '',
            right:   '',
            left: 'title',
            },
            events: theEvents
          });
      });
  </script>
  </div>
  <div class="month">
    <% absences = attendance.absences %>
    <% lates = attendance.lates %>
    <div class="column span-5 attendence-description">
      <h3 class="list-heading">Summary:</h3>
      <div>
        Total days absent: <%= absences.count %>
      </div>
      <div>
        Total days late: <%= lates.count %>
      </div>
  <br />
  <br />
  <% if attendance.anomalies.present? %>
    <h3 class="list-heading">Details:</h3>
    <% absences.each do |a| %>
      <div>
        <%= "Absent: #{a.school_date.month}/#{a.school_date.day}" %>
      </div>
    <% end %>
    <% lates.each do |l| %>
      <div>
        <%= "Late (#{l.moment.hour - 4} AM): #{l.school_date.month}/#{l.school_date.day}" %>
      </div>
    <% end %>
    
  <% end %>

</div>
<div class="column span-7 attendance-comment">
      <% form_tag(save_comment_path, :remote => true, :name => "comment #{attendance.id}") do %>
        <% if attendance.comment_list.blank? %>
          <%= text_area_tag "comment", "", :placeholder => "Write comments here"  %>
        <% else %>
          <%= text_area_tag "comment", attendance.comment_list.first %>
        <% end %>
        <%= hidden_field_tag "model", "attendance" %>
        <%= hidden_field_tag "object_id", attendance.id %>
        <div class="submit-button">
          <%= submit_tag "Save Comment" %>
        </div>
      <% end %>
</div>
  </div>
<% end %>
